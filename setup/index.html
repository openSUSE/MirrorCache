<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Mirror redirector web service"><meta name=author content="openSUSE contributors"><link href=https://www.mirrorcache.org/setup/ rel=canonical><link href=../mb_compare/ rel=prev><link rel=icon href=../assets/logo-16.png><meta name=generator content="mkdocs-1.4.2, mkdocs-material-9.0.1"><title>Setup - MirrorCache documentation</title><link rel=stylesheet href=../assets/stylesheets/main.3bd4f189.min.css><link rel=stylesheet href=../assets/stylesheets/palette.2505c338.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=green> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#setup class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=.. title="MirrorCache documentation" class="md-header__button md-logo" aria-label="MirrorCache documentation" data-md-component=logo> <img src=../assets/logo.svg alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> MirrorCache documentation </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Setup </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=green aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=green aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/openSUSE/MirrorCache title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> openSUSE/MirrorCache </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=.. title="MirrorCache documentation" class="md-nav__button md-logo" aria-label="MirrorCache documentation" data-md-component=logo> <img src=../assets/logo.svg alt=logo> </a> MirrorCache documentation </label> <div class=md-nav__source> <a href=https://github.com/openSUSE/MirrorCache title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> openSUSE/MirrorCache </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. class=md-nav__link> Home </a> </li> <li class=md-nav__item> <a href=../flow/ class=md-nav__link> Overview and concept </a> </li> <li class=md-nav__item> <a href=../mb_compare/ class=md-nav__link> MirrorCache vs MirrorBrain </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Setup <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Setup </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#common-setup class=md-nav__link> Common Setup </a> <nav class=md-nav aria-label="Common Setup"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#environment-variables class=md-nav__link> Environment variables </a> </li> <li class=md-nav__item> <a href=#geoip-location class=md-nav__link> GeoIP location </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#types-of-install class=md-nav__link> Types of install </a> <nav class=md-nav aria-label="Types of install"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#install-package class=md-nav__link> Install package </a> </li> <li class=md-nav__item> <a href=#setup-systemd-from-source class=md-nav__link> Setup systemd from source </a> </li> <li class=md-nav__item> <a href=#development-setup class=md-nav__link> Development setup </a> </li> <li class=md-nav__item> <a href=#development-setup-using-environ-framework class=md-nav__link> Development setup using environ framework </a> </li> <li class=md-nav__item> <a href=#run-tests-from-tenviron-with-docker-manually-for-debugging class=md-nav__link> Run tests from t/environ with docker, manually for debugging </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#common-setup class=md-nav__link> Common Setup </a> <nav class=md-nav aria-label="Common Setup"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#environment-variables class=md-nav__link> Environment variables </a> </li> <li class=md-nav__item> <a href=#geoip-location class=md-nav__link> GeoIP location </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#types-of-install class=md-nav__link> Types of install </a> <nav class=md-nav aria-label="Types of install"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#install-package class=md-nav__link> Install package </a> </li> <li class=md-nav__item> <a href=#setup-systemd-from-source class=md-nav__link> Setup systemd from source </a> </li> <li class=md-nav__item> <a href=#development-setup class=md-nav__link> Development setup </a> </li> <li class=md-nav__item> <a href=#development-setup-using-environ-framework class=md-nav__link> Development setup using environ framework </a> </li> <li class=md-nav__item> <a href=#run-tests-from-tenviron-with-docker-manually-for-debugging class=md-nav__link> Run tests from t/environ with docker, manually for debugging </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=setup>Setup<a class=headerlink href=#setup title="Permanent link">&para;</a></h1> <h2 id=common-setup>Common Setup<a class=headerlink href=#common-setup title="Permanent link">&para;</a></h2> <h3 id=environment-variables>Environment variables<a class=headerlink href=#environment-variables title="Permanent link">&para;</a></h3> <p>MirrorCache can be configured with following environment variables:</p> <ul> <li>MIRRORCACHE_ROOT (required): defines location of files, which needs redirection. It may be url, local folder or rsync address, e.g. <code>MIRRORCACHE_ROOT=http://download.opensuse.org</code> or <code>MIRRORCACHE_ROOT=/srv/mirrorcache</code> or <code>MIRRORCACHE_ROOT=rsync://user:password@myhost.com/module</code>. (Note that you must install additionally <code>perl-Digest-MD4</code> if rsync url needs password verification).</li> <li>MIRRORCACHE_AUTH_URL (optional) may contain remote openid server url (default https://www.opensuse.org/openid/user/). if explicitly set to empty value - all login attempt will be allowed and user set to 'Demo'.</li> <li>MIRRORCACHE_TOP_FOLDERS (space separated values) may be set to automatically redirect /folder to /download/folder.</li> <li>For reference of using MOJO_LISTEN variable refer Mojolicious documentation, e.g. <code>MOJO_LISTEN=http://*:8000</code></li> <li>It is recommended to run MirrorCache daemon behind another streamline WebService, e.g. Apache or haproxy. Thus <code>MOJO_REVERSE_PROXY=1</code> will be needed.</li> <li>MIRRORCACHE_REDIRECT is needed for use when MIRRORCACHE_ROOT is set to remote address. Requests will be redirected to this location when no mirror is found, e.g. MIRRORCACHE_REDIRECT=downloadcontent.opensuse.org</li> <li>MIRRORCACHE_METALINK_PUBLISHER may be set to customize publisher in metalink generation.</li> <li>MIRRORCACHE_METALINK_PUBLISHER_URL may be set to customize url of publisher in metalink generation.</li> <li>MIRRORCACHE_BRANDING loads files from <a href=/templates/branding>templates/branding</a>. Use the <code>default</code> folder as a base for your own branding and set this environment variable to the name of the newly created folder.</li> <li>MIRRORCACHE_VPN_PREFIX - MirrorCache will use column server.hostname_vpn for redirecting if client IP has prefix as defined by MIRRORCACHE_VPN_PREFIX.</li> </ul> <p>Without any database configuration MirrorCache will attempt to connect to database 'mirrorcache' on default PostgreSQL port 5432. Following variables can be used to configure database access:</p> <ul> <li>MIRRORCACHE_DBUSER (default empty)</li> <li>MIRRORCACHE_DBPASS (default empty)</li> <li>TEST_PG or MIRRORCACHE_DSN , e.g. MIRRORCACHE_DSN='DBI:Pg:dbname=mc_dev;host=/path/to/pg'` If neither TEST_PG nor MIRRORCACHE_DSN is defined, following variables are used:</li> <li>MIRRORCACHE_DB (default 'mirrorcache')</li> <li>MIRRORCACHE_DBHOST (default empty)</li> <li>MIRRORCACHE_DBPORT (default empty)</li> </ul> <h3 id=geoip-location>GeoIP location<a class=headerlink href=#geoip-location title="Permanent link">&para;</a></h3> <ul> <li>If environment variable MIRRORCACHE_CITY_MMDB or MIRRORCACHE_IP2LOCATION is defined, the app will attempt to detect country of the request and find a mirror in the same country, e.g. <code>MIRRORCACHE_CITY_MMDB=/var/lib/GeoIP/GeoLite2-City.mmdb</code> or <code>MIRRORCACHE_IP2LOCATION=/var/lib/GeoIP/IP2LOCATION-LITE-DB5.IPV6.BIN</code>.</li> <li>See Maxmind or IP2Location website to obtain such file.</li> <li>Additional dependencies must be installed as well for GeoIP location to work: perl modules Mojolicious::Plugin::ClientIP and MaxMind::DB::Reader : <div class=highlight><pre><span></span><code># for Maxmind
zypper in perl-Mojolicious-Plugin-ClientIP perl-MaxMind-DB-Reader

# for IP2Location
zypper in perl-Geo-IP2Location
</code></pre></div></li> </ul> <h2 id=types-of-install>Types of install<a class=headerlink href=#types-of-install title="Permanent link">&para;</a></h2> <h3 id=install-package>Install package<a class=headerlink href=#install-package title="Permanent link">&para;</a></h3> <p>An example for openSUSE <div class=highlight><pre><span></span><code>zypper<span class=w> </span>ar<span class=w> </span>-f<span class=w> </span>obs://openSUSE:infrastructure:MirrorCache<span class=w> </span>MirrorCache
zypper<span class=w> </span>refresh<span class=w> </span>-s
zypper<span class=w> </span>install<span class=w> </span>MirrorCache

zypper<span class=w> </span>install<span class=w> </span>postgresql<span class=w> </span>postgresql-server
systemctl<span class=w> </span><span class=nb>enable</span><span class=w> </span>postgresql

sudo<span class=w> </span>-u<span class=w> </span>postgres<span class=w> </span>createuser<span class=w> </span>mirrorcache
sudo<span class=w> </span>-u<span class=w> </span>postgres<span class=w> </span>createdb<span class=w> </span>mirrorcache

<span class=c1># the services read environment variables from /etc/mirrorcache/conf.env by default</span>
<span class=nb>echo</span><span class=w> </span><span class=s2>&quot;MIRRORCACHE_ROOT=http://download.opensuse.org</span>
<span class=s2>MIRRORCACHE_TOP_FOLDERS=&#39;debug distribution factory history ports repositories source tumbleweed update&#39;</span>
<span class=s2>MOJO_LISTEN=http://*:8000</span>
<span class=s2>&quot;</span><span class=w> </span>&gt;&gt;<span class=w> </span>/etc/mirrorcache/conf.env

systemctl<span class=w> </span><span class=nb>enable</span><span class=w> </span>mirrorcache
systemctl<span class=w> </span><span class=nb>enable</span><span class=w> </span>mirrorcache-backstage
</code></pre></div></p> <h3 id=setup-systemd-from-source>Setup systemd from source<a class=headerlink href=#setup-systemd-from-source title="Permanent link">&para;</a></h3> <ol> <li>Install prerequisites. The project is based on Perl Mojolicious framework and set of Perl packages. The best way to install them is to reuse zypper and cpanm commands from CI environment: <code>t/environ/lib/Dockerfile.environ</code></li> </ol> <p>You may skip installing MaxMind::DB::Reader and Mojolicious::Plugin::ClientIP if you don't need Geolocation detection, if you don't need MirrorCache to find a mirror in client's country. From now on it will be referenced as 'Geolocation feature'.</p> <ol> <li> <p>You may need GeoIP database (optional, if 'Geolocation feature' is needed). <code>/var/lib/GeoIP/GeoLite2-City.mmdb</code> or <code>/var/lib/GeoIP/IP2LOCATION-LITE-DB5.IPV6.BIN</code> In such case you will also need following command in next step: <div class=highlight><pre><span></span><code><span class=c1># for MaxMind database</span>
<span class=nb>echo</span><span class=w> </span><span class=nv>MIRRORCACHE_CITY_MMDB</span><span class=o>=</span>/var/lib/GeoIP/GeoLite2-City.mmdb<span class=w> </span>&gt;&gt;<span class=w> </span>/etc/mirrorcache/conf.env
<span class=c1># or for IP2Location database</span>
<span class=nb>echo</span><span class=w> </span><span class=nv>MIRRORCACHE_IP2LOCATION</span><span class=o>=</span>/var/lib/GeoIP/IP2LOCATION-LITE-DB5.IPV6.BIN<span class=w> </span>&gt;&gt;<span class=w> </span>/usr/share/mirrorcache/conf.env
</code></pre></div></p> </li> <li> <p>Setup Use following script as root for inspiration (see also t/systemd/01-smoke.t) <div class=highlight><pre><span></span><code><span class=c1># assume local PostgreSQL server is up and running with default config</span>
make<span class=w> </span>install
make<span class=w> </span>setup_production_assets
make<span class=w> </span>setup_system_user
make<span class=w> </span>setup_system_db
<span class=c1># the services read environment variables from /etc/mirrorcache/conf.env by default</span>
<span class=nb>echo</span><span class=w> </span><span class=s2>&quot;MIRRORCACHE_ROOT=http://download.opensuse.org</span>
<span class=s2>MIRRORCACHE_TOP_FOLDERS=&#39;debug distribution factory history ports repositories source tumbleweed update&#39;</span>
<span class=s2>MOJO_LISTEN=http://*:8000</span>
<span class=s2>&quot;</span><span class=w> </span>&gt;&gt;<span class=w> </span>/etc/mirrorcache/conf.env

systemctl<span class=w> </span><span class=nb>enable</span><span class=w> </span>mirrorcache
systemctl<span class=w> </span><span class=nb>enable</span><span class=w> </span>mirrorcache-backstage

<span class=c1># log into UI and provide admin rights to the user:</span>
sudo<span class=w> </span>-u<span class=w> </span>mirrorcache<span class=w> </span>psql<span class=w> </span>-c<span class=w> </span><span class=s2>&quot;update acc set is_admin=1 where nickname=&#39;myusername&#39;&quot;</span><span class=w> </span>mirrorcache
<span class=c1># add mirrors using UI or sql</span>
sudo<span class=w> </span>-u<span class=w> </span>mirrorcache<span class=w> </span>psql<span class=w> </span>-c<span class=w> </span><span class=s2>&quot;insert into server(hostname,urldir,enabled,country,region) select &#39;mirror.aarnet.edu.au&#39;,&#39;/pub/opensuse/opensuse&#39;,&#39;t&#39;,&#39;au&#39;,&#39;&#39;&quot;</span><span class=w> </span>mirrorcache
</code></pre></div></p> </li> </ol> <h3 id=development-setup>Development setup<a class=headerlink href=#development-setup title="Permanent link">&para;</a></h3> <ol> <li>Install prerequisites. The project is based on Perl Mojolicious framework and set of Perl packages. The best way to install them is to reuse zypper and cpanm commands from CI environment: <code>t/environ/lib/Dockerfile.environ</code></li> </ol> <p>You may skip installing MaxMind::DB::Reader and Mojolicious::Plugin::ClientIP if you don't need Geolocation detection, if you don't need MirrorCache to find a mirror in client's country. From now on it will be referenced as 'Geolocation feature'.</p> <ol> <li> <p>You may need GeoIP database (optional, if 'Geolocation feature' is needed). <code>/var/lib/GeoIP/GeoLite2-City.mmdb</code> or <code>/var/lib/GeoIP/IP2LOCATION-LITE-DB5.IPV6.BIN</code></p> </li> <li> <p>You will need PostgreSQL server running, create database for mirrorcache and create tables: <div class=highlight><pre><span></span><code>createdb mc_dev
psql -f sql/schema.sql mc_dev
</code></pre></div> It is possible to run PostgreSQL on dedicated server as well.</p> </li> <li> <p>Example parameters to start WebApp: <div class=highlight><pre><span></span><code><span class=nv>TEST_PG</span><span class=o>=</span><span class=s1>&#39;DBI:Pg:dbname=mc_dev;host=/path/to/pg&#39;</span><span class=w> </span><span class=se>\</span>
<span class=nv>MIRRORCACHE_ROOT</span><span class=o>=</span>http://download.opensuse.org<span class=w> </span><span class=se>\</span>
<span class=nv>MIRRORCACHE_TOP_FOLDERS</span><span class=o>=</span><span class=s1>&#39;debug distribution factory history ports repositories source tumbleweed update&#39;</span><span class=w> </span><span class=se>\</span>
<span class=nv>MIRRORCACHE_CITY_MMDB</span><span class=o>=</span>/var/lib/GeoIP/GeoLite2-City.mmdb<span class=w> </span><span class=se>\ </span><span class=c1># MIRRORCACHE_IP2LOCATION=/var/lib/GeoIP/IP2LOCATION-LITE-DB5.IPV6.BIN \</span>
<span class=nv>MOJO_REVERSE_PROXY</span><span class=o>=</span><span class=m>1</span><span class=w> </span><span class=se>\</span>
<span class=nv>MOJO_LISTEN</span><span class=o>=</span>http://*:8000<span class=w> </span><span class=se>\</span>
script/mirrorcache<span class=w> </span>daemon
</code></pre></div></p> </li> <li> <p>To start background jobs: <div class=highlight><pre><span></span><code><span class=nv>TEST_PG</span><span class=o>=</span><span class=s1>&#39;DBI:Pg:dbname=mc_dev;host=/path/to/pg&#39;</span><span class=w> </span><span class=se>\</span>
<span class=nv>MIRRORCACHE_ROOT</span><span class=o>=</span>http://download.opensuse.org<span class=w> </span><span class=se>\</span>
script/mirrorcache<span class=w> </span>backstage<span class=w> </span>run<span class=w> </span>-j<span class=w> </span><span class=m>16</span>
</code></pre></div></p> </li> <li> <p>Add mirrors using UI or sql, e.g.: <div class=highlight><pre><span></span><code><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>server</span><span class=p>(</span><span class=n>hostname</span><span class=p>,</span><span class=n>urldir</span><span class=p>,</span><span class=n>enabled</span><span class=p>,</span><span class=n>country</span><span class=p>,</span><span class=n>region</span><span class=p>)</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=s1>&#39;mirror.aarnet.edu.au&#39;</span><span class=p>,</span><span class=s1>&#39;/pub/opensuse/opensuse&#39;</span><span class=p>,</span><span class=s1>&#39;t&#39;</span><span class=p>,</span><span class=s1>&#39;au&#39;</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>;</span>
<span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>server</span><span class=p>(</span><span class=n>hostname</span><span class=p>,</span><span class=n>urldir</span><span class=p>,</span><span class=n>enabled</span><span class=p>,</span><span class=n>country</span><span class=p>,</span><span class=n>region</span><span class=p>)</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=s1>&#39;ftp.iinet.net.au&#39;</span><span class=p>,</span><span class=s1>&#39;/pub/opensuse&#39;</span><span class=p>,</span><span class=s1>&#39;t&#39;</span><span class=p>,</span><span class=s1>&#39;au&#39;</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>;</span>
<span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>server</span><span class=p>(</span><span class=n>hostname</span><span class=p>,</span><span class=n>urldir</span><span class=p>,</span><span class=n>enabled</span><span class=p>,</span><span class=n>country</span><span class=p>,</span><span class=n>region</span><span class=p>)</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=s1>&#39;mirror.intergrid.com.au&#39;</span><span class=p>,</span><span class=s1>&#39;/opensuse&#39;</span><span class=p>,</span><span class=s1>&#39;t&#39;</span><span class=p>,</span><span class=s1>&#39;au&#39;</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>;</span>
<span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>server</span><span class=p>(</span><span class=n>hostname</span><span class=p>,</span><span class=n>urldir</span><span class=p>,</span><span class=n>enabled</span><span class=p>,</span><span class=n>country</span><span class=p>,</span><span class=n>region</span><span class=p>)</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=s1>&#39;mirror.internode.on.net&#39;</span><span class=p>,</span><span class=s1>&#39;/pub/opensuse&#39;</span><span class=p>,</span><span class=s1>&#39;t&#39;</span><span class=p>,</span><span class=s1>&#39;au&#39;</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>;</span>
<span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>server</span><span class=p>(</span><span class=n>hostname</span><span class=p>,</span><span class=n>urldir</span><span class=p>,</span><span class=n>enabled</span><span class=p>,</span><span class=n>country</span><span class=p>,</span><span class=n>region</span><span class=p>)</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=s1>&#39;ftp.netspace.net.au&#39;</span><span class=p>,</span><span class=s1>&#39;/pub/opensuse&#39;</span><span class=p>,</span><span class=s1>&#39;t&#39;</span><span class=p>,</span><span class=s1>&#39;au&#39;</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>;</span>
</code></pre></div></p> </li> <li> <p>Log in using UI and add admin privilege to the user: <div class=highlight><pre><span></span><code><span class=k>update</span><span class=w> </span><span class=n>acc</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=n>is_admin</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>nickname</span><span class=o>=</span><span class=s1>&#39;myusername&#39;</span><span class=p>;</span>
</code></pre></div></p> </li> </ol> <h3 id=development-setup-using-environ-framework>Development setup using environ framework<a class=headerlink href=#development-setup-using-environ-framework title="Permanent link">&para;</a></h3> <p>environ framework provides a way to manage development setup of various products without root permissions. Such approach is useful in manual and integration testing, especially when various topologies are required. MirrorCache project uses environ framework in CI, e.g. to start several Apache instances, configure them as mirrors, try different scenarios: http/https redirection, one of mirrors is down, a file is gone from a mirror, etc.</p> <p>E.g. steps 2 - 7 above using environ framework. <div class=highlight><pre><span></span><code><span class=c1># Needs environ utility installed, as well templates for Apache, nginx, postgres, rsync</span>
git<span class=w> </span>clone<span class=w> </span>https://github.com/andrii-suse/environ
sudo<span class=w> </span>make<span class=w> </span>-C<span class=w> </span>environ<span class=w> </span>install
<span class=c1># First choose a slot to use in script, mc0 - mc9 are available, so several instances at the same time</span>
<span class=c1># here we will use slot 1 =&gt; mc1, first parameter is where MirrorCache sources are located</span>
<span class=nv>mc</span><span class=o>=</span><span class=k>$(</span>environ<span class=w> </span>mc<span class=w> </span>~/github/MirrorCache<span class=k>)</span>
<span class=c1># pg1-system2 will setup local instance of Postgres server with data directory in pg1-system2/dt/</span>
<span class=nv>$mc</span>/gen_config<span class=w> </span><span class=nv>MIRRORCACHE_ROOT</span><span class=o>=</span>http://download.opensuse.org<span class=w> </span><span class=se>\</span>
<span class=w>     </span><span class=nv>MIRRORCACHE_TOP_FOLDERS</span><span class=o>=</span><span class=s2>&quot;&#39;debug distribution factory history ports repositories source tumbleweed update&#39;&quot;</span><span class=w> </span><span class=se>\</span>
<span class=w>    </span><span class=nv>MIRRORCACHE_CITY_MMDB</span><span class=o>=</span>/var/lib/GeoIP/GeoLite2-City.mmdb<span class=w> </span><span class=se>\ </span><span class=c1># MIRRORCACHE_IP2LOCATION=/var/lib/GeoIP/IP2LOCATION-LITE-DB5.IPV6.BIN \</span>
<span class=w>    </span><span class=nv>MOJO_REVERSE_PROXY</span><span class=o>=</span><span class=m>1</span>

<span class=nv>$mc</span>/start

<span class=nv>$mc</span>/backstage/start

<span class=nv>$mc</span>/db/sql<span class=w> </span><span class=s2>&quot;insert into server(hostname,urldir,enabled,country,region) select &#39;mirror.aarnet.edu.au&#39;,&#39;/pub/opensuse/opensuse&#39;,&#39;t&#39;,&#39;au&#39;,&#39;&#39;&quot;</span>

<span class=c1># check status</span>
<span class=nv>$mc</span>/db/status
<span class=nv>$mc</span>/backstage/status
<span class=nv>$mc</span>/status
</code></pre></div></p> <h3 id=run-tests-from-tenviron-with-docker-manually-for-debugging>Run tests from <a href=/t/environ>t/environ</a> with docker, manually for debugging<a class=headerlink href=#run-tests-from-tenviron-with-docker-manually-for-debugging title="Permanent link">&para;</a></h3> <p><strong>Note:</strong> Requires docker configured for non-root users</p> <p><code>MIRRORCACHE_CITY_MMDB</code> adds this environment variable inside the container and mounts it as a volume if the file exists on the host</p> <p><code>EXPOSE_PORT</code> maps whatever port you need from the container to host port 80</p> <div class=highlight><pre><span></span><code>cd t/environ

# Just run the test:
./01-smoke.sh

# Run the test with your own MIRRORCACHE_CITY_MMDB
MIRRORCACHE_CITY_MMDB=/var/lib/GeoIP/GeoLite2-City.mmdb ./01-smoke.sh

# Run the test and keep the container, while mapping port 3110 to host port 80
EXPOSE_PORT=3110 ./01-smoke.sh
</code></pre></div> <p>To log in with a fake test-user, change <code>$mc/start</code> to <code>MIRRORCACHE_TEST_TRUST_AUTH=1 $mc/start</code> in your test</p> <p>Setting <code>MIRRORCACHE_TEST_TRUST_AUTH</code> to any number &gt; 1 will result in <code>current_user</code> being <code>undef</code>, so no fake test-user login. You will only have access to some routes defined in <a href=/lib/MirrorCache/WebAPI.pm>lib/MirrorCache/WebAPI.pm</a>.</p> <p><strong>WARNING</strong> - Be careful when working inside container: 1. The source tree is mapped to the host, so any changes of source code inside container will be reflected on host and vice versa. 2. The container is removed automatically on next test start of the same test, so any modifications outside source tree will be lost.</p> <p>Don't forget to clean up the test containers when you're done :)</p> <hr> <div class=md-source-file> <small> Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">January 14, 2022</span> </small> </div> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </a> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> &copy; 2020-2021 openSUSE contributors </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": ["navigation.instant", "navigation.expand", "navigation.top"], "search": "../assets/javascripts/workers/search.12658920.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../assets/javascripts/bundle.5cf534bf.min.js></script> </body> </html>